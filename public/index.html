<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üßß Êñ∞Âπ¥Á¶èÂà©</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    :root {
      --red: #C41E3A;
      --gold: #FFD700;
      --dark: #1a0a0a;
      --glass: rgba(255, 255, 255, 0.08)
    }

    body {
      min-height: 100vh;
      background: #1a0a0a;
      background-image:
        radial-gradient(circle at 50% 30%, #3a0000, #1a0a0a 80%),
        repeating-linear-gradient(45deg, rgba(255, 215, 0, 0.02) 0px, rgba(255, 215, 0, 0.02) 2px, transparent 2px, transparent 12px);
      font-family: -apple-system, 'PingFang SC', 'Microsoft YaHei', sans-serif;
      color: #fff;
      overflow-x: hidden;
    }

    /* Â∏ÉÂ±Ä */
    .page {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      position: relative;
      padding-top: 56px
    }

    /* È°∂ÈÉ®Ë£ÖÈ•∞ */
    .header {
      text-align: center;
      padding: 30px 20px 10px;
      position: relative;
      z-index: 2
    }

    .header h1 {
      font-size: 2.2em;
      letter-spacing: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px
    }

    .header h1 .title-text {
      background: linear-gradient(to bottom, #FFD700, #FFA500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    }

    .header h1 .lantern {
      font-size: 0.9em;
      -webkit-text-fill-color: initial;
      filter: none;
      animation: lantern-swing 2s ease-in-out infinite alternate
    }

    @keyframes lantern-swing {
      0% {
        transform: rotate(-8deg)
      }

      100% {
        transform: rotate(8deg)
      }
    }

    .header p {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.9em;
      margin-top: 6px
    }

    /* ‰∏ªÂå∫Âüü */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 20px;
      max-width: 400px;
      width: 100%;
      position: relative;
      z-index: 2
    }

    /* ËΩ¨Áõò */
    .wheel-wrap {
      position: relative;
      width: 310px;
      height: 310px;
      margin: 10px auto 28px;
      filter: drop-shadow(0 8px 25px rgba(0, 0, 0, 0.5))
    }

    .wheel-glow {
      position: absolute;
      width: 330px;
      height: 330px;
      top: -10px;
      left: -10px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.15) 0%, transparent 70%);
      opacity: 0.7;
      filter: blur(3px);
      animation: spin-glow 8s linear infinite;
    }

    @keyframes spin-glow {
      to {
        transform: rotate(360deg)
      }
    }

    canvas#wheel {
      position: absolute;
      top: 0;
      left: 0;
      width: 310px;
      height: 310px;
      border-radius: 50%;
      z-index: 2
    }

    /* CSS ÊåáÈíà */
    .pointer {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      width: 36px;
      height: 46px;
      filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.4));
    }

    .pointer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      clip-path: polygon(50% 100%, 0 0, 100% 0);
      background: linear-gradient(to right, #FFD700, #FFFFE0 50%, #FFA500);
    }

    .pointer::after {
      content: '';
      position: absolute;
      top: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 0 0 3px #C41E3A, 0 0 8px rgba(196, 30, 58, 0.5);
    }

    /* ËæìÂÖ• */
    .input-group {
      width: 100%;
      margin-bottom: 16px
    }

    .input-group input {
      width: 100%;
      padding: 14px 20px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 14px;
      background: var(--glass);
      color: #fff;
      font-size: 15px;
      text-align: center;
      outline: none;
      backdrop-filter: blur(20px);
      transition: all 0.3s;
    }

    .input-group input::placeholder {
      color: rgba(255, 255, 255, 0.35)
    }

    .input-group input:focus {
      border-color: var(--gold);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.15)
    }

    .btn-draw {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--gold), #FFA500);
      color: var(--dark);
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.2);
      animation: pulse 2s infinite;
    }

    .btn-draw:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(255, 165, 0, 0.4)
    }

    .btn-draw:active {
      transform: translateY(0)
    }

    .btn-draw:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      animation: none
    }

    .btn-draw::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: 0.5s;
    }

    .btn-draw:hover::after {
      left: 100%
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4)
      }

      70% {
        box-shadow: 0 0 0 12px rgba(255, 215, 0, 0)
      }

      100% {
        box-shadow: 0 0 0 0 rgba(255, 215, 0, 0)
      }
    }

    .hint {
      text-align: center;
      margin-top: 12px;
      font-size: 0.75em;
      color: rgba(255, 255, 255, 0.3)
    }

    /* ===== ‰∏≠Â•ñÊí≠Êä• (Mobile: È°∂ÈÉ®Âõ∫ÂÆöË∑ëÈ©¨ÁÅØ) ===== */
    .ticker-section {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 48px;
      z-index: 100;
      background: rgba(26, 10, 10, 0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 215, 0, 0.2);
      display: flex;
      align-items: center;
    }

    .ticker-bar {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      overflow: hidden;
      position: relative;
    }

    .ticker-label {
      padding: 0 12px;
      font-size: 0.85em;
      font-weight: 700;
      color: var(--gold);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      background: linear-gradient(90deg, rgba(196, 30, 58, 0.25), transparent);
      height: 100%;
    }

    .ticker-track {
      flex: 1;
      height: 100%;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      mask-image: linear-gradient(90deg, transparent, #000 20px, #000 90%, transparent);
      -webkit-mask-image: linear-gradient(90deg, transparent, #000 20px, #000 90%, transparent);
    }

    .ticker-scroll {
      display: flex;
      white-space: nowrap;
      animation: marquee 18s linear infinite;
    }

    .ticker-msg {
      display: inline-flex;
      align-items: center;
      padding-right: 28px;
      font-size: 0.85em;
      color: rgba(255, 255, 255, 0.8);
      line-height: 48px;
    }

    .ticker-msg .emoji {
      margin-right: 6px
    }

    .ticker-msg .name {
      color: var(--gold);
      font-weight: 600
    }

    .ticker-msg .prize {
      color: #ffaaaa;
      font-weight: 600;
      margin-left: 2px
    }

    /* ===== PC ‰æßËæπÊí≠Êä• ===== */
    @media(min-width:900px) {
      .page {
        flex-direction: row;
        justify-content: center;
        align-items: center;
        padding-top: 0
      }

      .center-col {
        flex: 0 0 440px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh
      }

      .ticker-section {
        position: fixed;
        right: 40px;
        top: 50%;
        transform: translateY(-50%);
        width: 260px;
        height: 380px;
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 215, 0, 0.15);
        border-radius: 16px;
        flex-direction: column;
        align-items: stretch;
        padding: 0;
        border-bottom: none;
        left: auto;
      }

      .ticker-bar {
        flex-direction: column;
        width: 100%;
        height: 100%
      }

      .ticker-label {
        width: 100%;
        height: 44px;
        justify-content: center;
        padding: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        font-size: 1em;
        letter-spacing: 1px;
        background: linear-gradient(180deg, rgba(196, 30, 58, 0.35), transparent);
        border-radius: 16px 16px 0 0;
      }

      .ticker-track {
        flex: 1;
        width: 100%;
        padding: 8px 0;
        display: block;
        mask-image: linear-gradient(180deg, transparent, #000 8%, #000 92%, transparent);
        -webkit-mask-image: linear-gradient(180deg, transparent, #000 8%, #000 92%, transparent);
      }

      .ticker-scroll {
        flex-direction: column;
        position: relative;
        white-space: normal;
        animation: scrollUp 16s linear infinite;
      }

      .ticker-msg {
        width: 100%;
        padding: 9px 16px;
        line-height: 1.5;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        justify-content: flex-start;
        font-size: 0.82em;
      }
    }

    @keyframes marquee {
      0% {
        transform: translateX(0)
      }

      100% {
        transform: translateX(-50%)
      }
    }

    @keyframes scrollUp {
      0% {
        transform: translateY(0)
      }

      100% {
        transform: translateY(-50%)
      }
    }

    /* ===== ÂºπÁ™ó ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: 200;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(8px);
    }

    .modal-overlay.show {
      display: flex
    }

    .modal {
      background: linear-gradient(160deg, #1e1e2e, #2a1a1a);
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 24px;
      padding: 35px 28px;
      max-width: 360px;
      width: 88%;
      text-align: center;
      color: #fff;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
      animation: modalIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes modalIn {
      from {
        transform: scale(0.7) translateY(30px);
        opacity: 0
      }

      to {
        transform: scale(1) translateY(0);
        opacity: 1
      }
    }

    .modal .tier-badge {
      display: inline-block;
      padding: 8px 24px;
      border-radius: 50px;
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 20px;
      animation: tierBounce 0.6s ease-out;
    }

    .tier-0 {
      background: linear-gradient(135deg, #FF1744, #FFD700);
      color: #fff;
      box-shadow: 0 0 24px rgba(255, 215, 0, 0.5)
    }

    .tier-1 {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #1a0a0a
    }

    .tier-2 {
      background: linear-gradient(135deg, #FF6B6B, #FF8E53);
      color: #fff
    }

    .tier-3 {
      background: linear-gradient(135deg, #B0B0B0, #D8D8D8);
      color: #333
    }

    @keyframes tierBounce {
      0% {
        transform: scale(0)
      }

      60% {
        transform: scale(1.2)
      }

      100% {
        transform: scale(1)
      }
    }

    .prize-reveal {
      min-height: 70px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center
    }

    .prize-name {
      font-size: 1.4em;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 4px;
      animation: fadeUp 0.4s ease-out 0.8s both
    }

    .prize-desc {
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 12px;
      animation: fadeUp 0.4s ease-out 1s both
    }

    .wish {
      font-size: 0.95em;
      color: #FF8A65;
      margin-bottom: 16px;
      font-style: italic;
      animation: fadeUp 0.4s ease-out 1.2s both
    }

    @keyframes fadeUp {
      from {
        transform: translateY(15px);
        opacity: 0
      }

      to {
        transform: translateY(0);
        opacity: 1
      }
    }

    .code-box {
      background: rgba(255, 215, 0, 0.08);
      border: 1px dashed rgba(255, 215, 0, 0.3);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 14px;
      animation: fadeUp 0.4s ease-out 1.4s both;
    }

    .code-label {
      font-size: 0.75em;
      color: rgba(255, 255, 255, 0.4);
      margin-bottom: 4px
    }

    .code-value {
      font-size: 1.3em;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 3px;
      font-family: 'Courier New', monospace
    }

    .contact {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 12px;
      font-size: 0.85em;
      color: rgba(255, 255, 255, 0.6);
      animation: fadeUp 0.4s ease-out 1.6s both;
    }

    .btn-close {
      margin-top: 18px;
      padding: 10px 28px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(135deg, var(--red), #8B0000);
      color: #fff;
      font-size: 0.95em;
      cursor: pointer;
      animation: fadeUp 0.4s ease-out 1.8s both;
      transition: transform 0.2s;
    }

    .btn-close:hover {
      transform: scale(1.05)
    }

    /* ÂΩ©Â∏¶ */
    #confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 150
    }

    /* ËÉåÊôØÁ≤íÂ≠ê */
    .particle {
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.4), rgba(255, 165, 0, 0.1), transparent);
      animation: float linear infinite;
    }

    @keyframes float {
      0% {
        transform: translateY(0) scale(1);
        opacity: 0.5
      }

      50% {
        opacity: 0.8
      }

      100% {
        transform: translateY(-100vh) scale(0.3);
        opacity: 0
      }
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0)
      }

      25% {
        transform: translateX(-6px)
      }

      75% {
        transform: translateX(6px)
      }
    }
  </style>
</head>

<body>

  <div class="page">
    <div class="center-col">
      <div class="header">
        <h1><span class="lantern">üèÆ</span><span class="title-text">Êñ∞Âπ¥Â§ßËΩ¨Áõò</span><span class="lantern">üèÆ</span></h1>
        <p>ÁÇπÂáªÂºÄÂßãÊäΩÂ•ñ</p>
      </div>

      <div class="main">
        <div class="wheel-wrap">
          <div class="wheel-glow"></div>
          <canvas id="wheel" width="620" height="620"></canvas>
          <div class="pointer"></div>
        </div>

        <div class="input-group">
          <input type="text" id="nickname" placeholder="ËæìÂÖ•‰Ω†ÁöÑÊòµÁß∞" maxlength="20" />
        </div>

        <button class="btn-draw" id="btnDraw" onclick="startDraw()">ÂºÄÂßãÊäΩÂ•ñ</button>
        <p class="hint">ÊØè‰∫∫ÈôêÊäΩ‰∏ÄÊ¨° ¬∑ 100% ‰∏≠Â•ñ</p>
      </div>

    </div>
  </div>

  <!-- Êí≠Êä•Êù°ÔºàÂõ∫ÂÆöÂÆö‰ΩçÔºåÁã¨Á´ã‰∫éÂ∏ÉÂ±ÄÔºâ -->
  <div class="ticker-section" id="tickerSection" style="display:none">
    <div class="ticker-bar">
      <div class="ticker-label">üèÜ ‰∏≠Â•ñÂêçÂçï</div>
      <div class="ticker-track">
        <div class="ticker-scroll" id="tickerScroll"></div>
      </div>
    </div>
  </div>

  <canvas id="confetti"></canvas>

  <!-- ÂºπÁ™ó -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="tier-badge" id="modalTier"></div>
      <div class="prize-reveal">
        <div class="prize-name" id="modalName"></div>
        <div class="prize-desc" id="modalDesc"></div>
      </div>
      <div class="wish" id="modalWish"></div>
      <div class="code-box">
        <div class="code-label">ÂÖëÊç¢Á†Å</div>
        <div class="code-value" id="modalCode"></div>
      </div>
      <div class="contact">üì± Êà™Âõæ‰øùÂ≠òÂÖëÊç¢Á†ÅÔºåËÅîÁ≥ªÊàëÂÖëÂ•ñÂñîÔΩû</div>
      <button class="btn-close" onclick="closeModal()">Êî∂‰∏ã‰∫ÜÔºÅ</button>
    </div>
  </div>

  <script>
    let prizes = [], spinning = false, currentRotation = 0;

    async function init() {
      const r = await fetch('/api/prizes?t=' + Date.now());
      prizes = await r.json();
      console.log('prizes visualWeights:', prizes.map(p => p.visualWeight));
      drawWheel();
      createParticles();
      loadTicker();
    }

    /* ÈöêÁßÅÂåñÂêçÂ≠óÔºö‰øùÁïôÈ¶ñÂ≠óÔºåÂÖ∂‰ΩôÁî® * */
    function maskName(name) {
      if (!name) return '***';
      const s = name.trim();
      if (s.length <= 1) return s + '*';
      return s[0] + '*'.repeat(s.length - 1);
    }

    /* È¢úËâ≤‰∫ÆÂ∫¶Ë∞ÉÊï¥ */
    function adjustColor(hex, amt) {
      let c = hex.replace('#', '');
      if (c.length === 3) c = c[0] + c[0] + c[1] + c[1] + c[2] + c[2];
      let num = parseInt(c, 16);
      let r = Math.min(255, Math.max(0, (num >> 16) + amt));
      let g = Math.min(255, Math.max(0, ((num >> 8) & 0xFF) + amt));
      let b = Math.min(255, Math.max(0, (num & 0xFF) + amt));
      return '#' + (b | (g << 8) | (r << 16)).toString(16).padStart(6, '0');
    }

    /* ËΩ¨Áõò ‚Äî ÊâáÂå∫Êåâ visualWeight ÂàÜÈÖçÂ§ßÂ∞è */
    function drawWheel() {
      const c = document.getElementById('wheel'), ctx = c.getContext('2d');
      const w = c.width, h = c.height;
      const cx = w / 2, cy = h / 2;
      const R = cx - 8;
      const rimW = 22;
      const sr = R - rimW;
      const n = prizes.length;
      const totalW = prizes.reduce((s, p) => s + (p.visualWeight || 1), 0);

      // È¢ÑËÆ°ÁÆóÊØè‰∏™ÊâáÂå∫ÁöÑËµ∑ÂßãËßíÂíåÂºßÂ∫¶
      const sectors = [];
      let cum = -Math.PI / 2;
      for (let i = 0; i < n; i++) {
        const arc = ((prizes[i].visualWeight || 1) / totalW) * 2 * Math.PI;
        sectors.push({ start: cum, arc });
        cum += arc;
      }

      ctx.clearRect(0, 0, w, h);

      // 1. Â§ñÂúàÈáëÂ±ûÂ∫ïÁõò
      const rimGrad = ctx.createLinearGradient(0, 0, w, h);
      rimGrad.addColorStop(0, '#FFD700'); rimGrad.addColorStop(0.3, '#FFA500');
      rimGrad.addColorStop(0.6, '#FFD700'); rimGrad.addColorStop(1, '#FFA500');
      ctx.beginPath(); ctx.arc(cx, cy, R, 0, 2 * Math.PI);
      ctx.fillStyle = rimGrad; ctx.fill();

      // 2. ÁÅØÊ≥°Ë£ÖÈ•∞Âúà (24 ‰∏™)
      const bulbCount = 24;
      for (let i = 0; i < bulbCount; i++) {
        const ang = i * (2 * Math.PI / bulbCount) - Math.PI / 2;
        const bx = cx + (R - rimW / 2) * Math.cos(ang);
        const by = cy + (R - rimW / 2) * Math.sin(ang);
        ctx.beginPath(); ctx.arc(bx, by, 4.5, 0, 2 * Math.PI);
        ctx.fillStyle = i % 2 === 0 ? '#FFFFFF' : '#FFEB3B';
        ctx.shadowBlur = 8; ctx.shadowColor = i % 2 === 0 ? 'rgba(255,255,255,0.8)' : 'rgba(255,235,59,0.8)';
        ctx.fill();
      }
      ctx.shadowBlur = 0;

      // 3. ÊâáÂå∫Â°´ÂÖÖ
      for (let i = 0; i < n; i++) {
        const { start: s, arc } = sectors[i];
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, sr, s, s + arc); ctx.closePath();

        const base = prizes[i].color;
        const grad = ctx.createRadialGradient(cx, cy, 20, cx, cy, sr);
        grad.addColorStop(0, adjustColor(base, 50));
        grad.addColorStop(1, base);
        ctx.fillStyle = grad; ctx.fill();
      }

      // ÂàÜÂâ≤Á∫ø
      for (let i = 0; i < n; i++) {
        ctx.beginPath(); ctx.moveTo(cx, cy);
        ctx.lineTo(cx + sr * Math.cos(sectors[i].start), cy + sr * Math.sin(sectors[i].start));
        ctx.strokeStyle = 'rgba(255,215,0,0.6)'; ctx.lineWidth = 2; ctx.stroke();
      }

      const btnR = 38;
      const textInnerGap = 10;
      const textOuterGap = 18;
      const textInnerR = btnR + textInnerGap;
      const textOuterR = sr - textOuterGap;
      const textCenterY = -((textInnerR + textOuterR) / 2);

      // Ê∏ÖÁêÜÂèØËÉΩÊÆãÁïôÁöÑÈò¥ÂΩ±Áä∂ÊÄÅÔºåÈÅøÂÖçÂΩ±ÂìçÊñáÂ≠óÊèèËæπ
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
      ctx.shadowColor = 'transparent';

      // 4. ÊñáÂ≠ó ‚Äî Â≠óÂè∑ÈöèÊâáÂå∫ÂÆΩÂ∫¶Ëá™ÈÄÇÂ∫î
      for (let i = 0; i < n; i++) {
        const { start: s, arc } = sectors[i];
        const arcDeg = arc * 180 / Math.PI;
        const fontSize = arcDeg < 28 ? 17 : arcDeg < 38 ? 20 : 22;
        const charGap = arcDeg < 28 ? 22 : arcDeg < 38 ? 25 : 28;
        ctx.save(); ctx.translate(cx, cy); ctx.rotate(s + arc / 2);
        ctx.font = `bold ${fontSize}px "PingFang SC",sans-serif`;
        ctx.textAlign = 'center';
        // middle Âü∫Á∫øÂØπ CJK ‰ºöÊúâËΩªÂæÆÂÖâÂ≠¶ÂÅèÂ∑ÆÔºåÊîπ‰∏∫ alphabetic + metrics Á≤æÁ°ÆÂ±Ö‰∏≠
        ctx.textBaseline = 'alphabetic';

        const label = prizes[i].tierName;
        const tier = prizes[i].tier;
        const textColor = tier === 0 ? '#FFEEB0' : tier === 1 ? '#FF4444' : '#fff';
        const strokeColor = tier === 0 ? 'rgba(180,140,0,0.6)' : tier === 1 ? 'rgba(100,70,0,0.7)' : 'rgba(0,0,0,0.5)';
        const chars = label.split('');

        // Âü∫‰∫éÂ≠óÂΩ¢ metrics ÂÅö‚ÄúÂÖâÂ≠¶‰∏≠ÂøÉ‚ÄùÔºö
        // ‰ªÖÁî® min/max ÂåÖÂõ¥Áõí‰ºöÊää‚ÄúÂ≠óÂΩ¢Â¢®Ê∞¥ÂàÜÂ∏É‰∏çÂùá‚ÄùÂøΩÁï•ÊéâÔºà‰æãÂ¶Ç‚Äú‰∫åÁ≠âÂ•ñ‚ÄùÈáå‚Äú‰∫å‚ÄùÊõ¥ËΩªÔºå‚ÄúÂ•ñ‚ÄùÊõ¥ÈáçÔºâÔºå
        // Âú®ÂÆΩÊâáÂå∫Èáå‰ºöÊòæÂæóÊï¥‰ΩìÂÅèÂêëÂÜÖ‰æß„ÄÇ
        const metrics = chars.map((ch, ci) => {
          const m = ctx.measureText(ch);
          const ascent = m.actualBoundingBoxAscent || fontSize * 0.78;
          const descent = m.actualBoundingBoxDescent || fontSize * 0.22;
          const inkW = (m.actualBoundingBoxLeft + m.actualBoundingBoxRight) || m.width || fontSize;
          const inkH = ascent + descent;
          const inkArea = Math.max(1, inkW * inkH);
          // ÂΩìÂâçÂ≠óÁ¨¶‚ÄúÂ¢®Ê∞¥‰∏≠ÂøÉ‚ÄùÁõ∏ÂØπÁ¨¨ 0 ‰∏™Â≠óÁ¨¶Âü∫Á∫øÁöÑ‰ΩçÁΩÆ
          const centerTerm = ci * charGap + (descent - ascent) / 2;
          return { ch, ci, centerTerm, inkArea };
        });
        const weightedCenter = metrics.reduce((sum, g) => sum + g.centerTerm * g.inkArea, 0)
          / metrics.reduce((sum, g) => sum + g.inkArea, 0);

        // ÂÆΩÊâáÂå∫Âú®ÊòéÊöóÊ∏êÂèò+ÊèèËæπ‰∏ã‰ªç‰ºöËΩªÂæÆÂÅèÂÜÖÔºåË°•‰∏ÄÁÇπÂêëÂ§ñÁöÑ optical nudge
        const opticalNudge = (prizes[i].visualWeight || 1) >= 4 ? -5 : 0; // 620px ÂùêÊ†áÔºåÁ∫¶Á≠â‰∫é CSS 2.5px
        const targetCenterY = textCenterY + opticalNudge;
        const baseY = targetCenterY - weightedCenter;

        ctx.strokeStyle = strokeColor;
        ctx.fillStyle = textColor;
        ctx.lineWidth = 3;
        ctx.lineJoin = 'round';

        metrics.forEach(g => {
          const ty = baseY + g.ci * charGap;
          ctx.strokeText(g.ch, 0, ty);
          ctx.fillText(g.ch, 0, ty);
        });
        ctx.restore();
      }

      // 4. ‰∏≠ÂøÉÊåâÈíÆ
      const btnGrad = ctx.createLinearGradient(cx - btnR, cy - btnR, cx + btnR, cy + btnR);
      btnGrad.addColorStop(0, '#FFD700'); btnGrad.addColorStop(1, '#FFA500');
      ctx.beginPath(); ctx.arc(cx, cy, btnR + 3, 0, 2 * Math.PI);
      ctx.fillStyle = 'rgba(139,0,0,0.4)'; ctx.fill();
      ctx.beginPath(); ctx.arc(cx, cy, btnR, 0, 2 * Math.PI);
      ctx.fillStyle = btnGrad;
      ctx.shadowBlur = 10; ctx.shadowColor = 'rgba(0,0,0,0.4)';
      ctx.fill(); ctx.shadowBlur = 0;

      ctx.fillStyle = '#8B0000';
      ctx.font = 'bold 30px "PingFang SC",sans-serif';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText('ÊäΩ', cx, cy + 2);
    }

    /* ÊäΩÂ•ñ */
    async function startDraw() {
      if (spinning) return;
      const nickname = document.getElementById('nickname').value.trim();
      if (!nickname) {
        const inp = document.getElementById('nickname');
        inp.style.animation = 'none'; inp.offsetHeight; inp.style.animation = 'shake 0.4s';
        return;
      }
      spinning = true;
      document.getElementById('btnDraw').disabled = true;

      const res = await fetch('/api/draw', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nickname })
      });
      const data = await res.json();

      if (data.error) { alert(data.error); spinning = false; document.getElementById('btnDraw').disabled = false; return }
      if (data.already) {
        showResult(data.prize, data.tierName || data.prize.tierName, '‰Ω†Â∑≤ÁªèÊäΩËøáÂï¶ÔΩûËøôÊòØ‰Ω†ÁöÑÂ•ñÂìÅ üòä');
        spinning = false; document.getElementById('btnDraw').disabled = false; return;
      }

      const prize = data.prize;
      const idx = prizes.findIndex(p => p.id === prize.id);
      // Êåâ visualWeight ËÆ°ÁÆóÁõÆÊ†áÊâáÂå∫‰∏≠ÂøÉËßíÂ∫¶
      // ËΩ¨ÁõòÁªòÂà∂‰ªé 12 ÁÇπÈíüÔºà-90¬∞ÔºâÂºÄÂßãÔºåÁ¨¨ 0 ‰∏™ÊâáÂå∫Â∞±Âú®ÊåáÈíàÊ≠£‰∏ãÊñπ
      // Ë¶ÅËÆ©Á¨¨ idx ‰∏™ÊâáÂå∫ÂØπÂáÜÊåáÈíàÔºåÈúÄË¶ÅÈ°∫Êó∂ÈíàÊóãËΩ¨‰ΩøÂÖ∂‰∏≠ÂøÉÂà∞Ëææ 12 ÁÇπÈíü‰ΩçÁΩÆ
      const totalW = prizes.reduce((s, p) => s + (p.visualWeight || 1), 0);
      let cumDeg = 0;
      for (let i = 0; i < idx; i++) cumDeg += ((prizes[i].visualWeight || 1) / totalW) * 360;
      const sectorDeg = ((prizes[idx].visualWeight || 1) / totalW) * 360;
      // ÊâáÂå∫‰∏≠ÂøÉÁõ∏ÂØπ‰∫é 12 ÁÇπÈíüÁöÑËßíÂ∫¶ÂÅèÁßª
      const sectorCenterDeg = cumDeg + sectorDeg / 2;
      // ÈúÄË¶ÅÊóãËΩ¨ÁöÑÁõÆÊ†áÔºöËÆ©Ëøô‰∏™ÊâáÂå∫‰∏≠ÂøÉÂà∞ËææÈ°∂ÈÉ®
      // È°∫Êó∂ÈíàÊóãËΩ¨ = 360 - sectorCenterDegÔºàÂèñÊ®°ÂêéÔºâ
      const targetAngle = 360 - (sectorCenterDeg % 360);
      // ÂáèÂéªÂΩìÂâçÂ∑≤ÊúâÁöÑÊóãËΩ¨ÂÅèÁßªÔºàÂèñÊ®°ÔºâÔºåÁ°Æ‰øùÊØèÊ¨°ÈÉΩÂáÜÁ°Æ
      const currentOffset = ((currentRotation % 360) + 360) % 360;
      const delta = ((targetAngle - currentOffset) % 360 + 360) % 360;
      const spins = 5 + Math.floor(Math.random() * 3);
      const total = spins * 360 + delta;

      const canvas = document.getElementById('wheel');
      canvas.style.transition = 'transform 4s cubic-bezier(0.17,0.67,0.12,0.99)';
      currentRotation += total;
      canvas.style.transform = `rotate(${currentRotation}deg)`;

      setTimeout(() => {
        canvas.style.transition = '';
        spinning = false;
        document.getElementById('btnDraw').disabled = false;
        launchConfetti();
        showResult(prize, data.tierName, data.message);
        addTickerMsg(nickname, data.tierName);
      }, 4200);
    }

    /* ÂºπÁ™ó */
    function showResult(prize, tierName, message) {
      const t = document.getElementById('modalTier');
      t.textContent = tierName; t.className = 'tier-badge tier-' + prize.tier;
      document.getElementById('modalName').textContent = prize.name;
      document.getElementById('modalDesc').textContent = prize.desc;
      document.getElementById('modalWish').textContent = message;
      document.getElementById('modalCode').textContent = prize.code || '‚Äî';
      document.getElementById('modal').classList.add('show');
    }
    function closeModal() { document.getElementById('modal').classList.remove('show') }

    /* Êí≠Êä• */
    async function loadTicker() {
      const r = await fetch('/api/draws');
      const draws = await r.json();
      if (draws.length === 0) return;
      document.getElementById('tickerSection').style.display = '';
      const el = document.getElementById('tickerScroll');
      el.innerHTML = '';
      const msgs = draws.reverse().map(d => buildTickerHTML(d.nickname, d.tierName));
      let all = [...msgs];
      while (all.length < 8) all = all.concat(msgs);
      all = [...all, ...all];
      all.forEach(html => { const div = document.createElement('div'); div.className = 'ticker-msg'; div.innerHTML = html; el.appendChild(div) });
    }

    function buildTickerHTML(nickname, tierName) {
      const masked = maskName(nickname);
      return `<span class="emoji">üéâ</span> ÊÅ≠Âñú <span class="name">${esc(masked)}</span> ÊäΩ‰∏≠ <span class="prize">[${esc(tierName)}]</span>`;
    }

    function addTickerMsg(nickname, tierName) {
      document.getElementById('tickerSection').style.display = '';
      loadTicker();
    }

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML }

    /* ÂΩ©Â∏¶ */
    function launchConfetti() {
      const c = document.getElementById('confetti'), ctx = c.getContext('2d');
      c.width = innerWidth; c.height = innerHeight;
      const P = [], colors = ['#FFD700', '#FF6B6B', '#FF4500', '#FFA500', '#FF1493', '#00FF88', '#4FC3F7', '#E040FB', '#C41E3A'];
      for (let i = 0; i < 200; i++) P.push({
        x: Math.random() * c.width, y: Math.random() * c.height - c.height,
        w: 6 + Math.random() * 8, h: 3 + Math.random() * 5,
        color: colors[Math.floor(Math.random() * colors.length)],
        vx: (Math.random() - 0.5) * 6, vy: 2 + Math.random() * 5,
        rot: Math.random() * 360, rv: (Math.random() - 0.5) * 12, op: 1
      });
      let f = 0;
      (function go() {
        ctx.clearRect(0, 0, c.width, c.height);
        let alive = false;
        P.forEach(p => {
          if (p.op <= 0) return; alive = true;
          p.x += p.vx; p.y += p.vy; p.vy += 0.06; p.rot += p.rv;
          if (f > 80) p.op -= 0.008;
          ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
          ctx.globalAlpha = Math.max(0, p.op); ctx.fillStyle = p.color;
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h); ctx.restore();
        });
        f++;
        if (alive && f < 350) requestAnimationFrame(go);
        else ctx.clearRect(0, 0, c.width, c.height);
      })();
    }

    /* ËÉåÊôØÁ≤íÂ≠ê */
    function createParticles() {
      for (let i = 0; i < 8; i++) {
        const p = document.createElement('div'); p.className = 'particle';
        const size = 60 + Math.random() * 120;
        p.style.cssText = `width:${size}px;height:${size}px;left:${Math.random() * 100}vw;bottom:-${size}px;animation-duration:${8 + Math.random() * 12}s;animation-delay:${Math.random() * 5}s`;
        document.body.appendChild(p);
      }
    }

    init();
  </script>
</body>

</html>