<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æŠ½å¥–ç®¡ç†åå°</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,"PingFang SC",sans-serif;background:#1a1a2e;color:#e0e0e0;min-height:100vh;padding:20px}
  .container{max-width:960px;margin:0 auto}
  h1{text-align:center;color:#FFD700;margin-bottom:8px;font-size:1.5em}
  .subtitle{text-align:center;color:#888;font-size:0.85em;margin-bottom:24px}

  .auth{text-align:center;margin-bottom:24px}
  .auth input{padding:10px 16px;border-radius:8px;border:1px solid #444;background:#2a2a3e;color:#fff;font-size:1em;width:200px}
  .auth button{padding:10px 20px;border-radius:8px;border:none;background:#FFD700;color:#1a1a2e;font-weight:700;cursor:pointer;margin-left:8px}

  .section{background:#16213e;border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid #2a2a4e}
  .section h2{color:#FFD700;font-size:1.1em;margin-bottom:16px;display:flex;align-items:center;gap:8px}

  /* å¥–å“å¡ç‰‡ */
  .prize-cards{display:flex;flex-direction:column;gap:12px}
  .prize-card{
    background:#1e2a4a;border:1px solid #2a3a5e;border-radius:10px;padding:16px;
    display:grid;grid-template-columns:auto 1fr;gap:10px 16px;align-items:center;
    transition:opacity 0.3s;
  }
  .prize-card.drawn{opacity:0.4;pointer-events:none}
  .prize-card .card-header{
    grid-column:1/-1;display:flex;align-items:center;gap:10px;
    padding-bottom:10px;border-bottom:1px solid #2a3a5e;
  }
  .prize-card .card-header .id-badge{
    width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    font-size:0.8em;font-weight:700;color:#fff;flex-shrink:0;
  }
  .prize-card .card-header .status{margin-left:auto;font-size:0.8em}
  .status-ok{color:#4CAF50}
  .status-drawn{color:#E53935}

  .field-label{font-size:0.8em;color:#888;text-align:right;white-space:nowrap}
  .field-row{display:flex;gap:8px;align-items:center}

  .inp{padding:7px 10px;border-radius:6px;border:1px solid #444;background:#2a2a3e;color:#fff;font-size:0.9em;transition:border-color 0.2s}
  .inp:focus{outline:none;border-color:#FFD700}
  .inp-name{width:180px}
  .inp-desc{flex:1;min-width:160px}
  .inp-tier-name{width:100px}
  .inp-num{width:70px;text-align:center}
  .inp-color{width:44px;height:32px;padding:2px;cursor:pointer;border-radius:6px;border:1px solid #444;background:#2a2a3e}

  select.inp{appearance:none;padding-right:24px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;background-size:10px}

  .prob-bar{height:5px;border-radius:3px;background:#333;margin-top:2px;overflow:hidden;width:100px}
  .prob-fill{height:100%;border-radius:3px;transition:width 0.3s}

  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
  .btn{padding:10px 24px;border-radius:8px;border:none;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s}
  .btn-save{background:#FFD700;color:#1a1a2e}
  .btn-save:hover{background:#FFA500}
  .btn-reset{background:#444;color:#e0e0e0}
  .btn-reset:hover{background:#555}
  .btn-danger{background:#E53935;color:#fff}
  .btn-danger:hover{background:#C62828}

  .toast{position:fixed;top:20px;right:20px;padding:12px 24px;border-radius:8px;color:#fff;font-weight:600;transform:translateX(120%);transition:transform 0.3s;z-index:999}
  .toast.show{transform:translateX(0)}
  .toast-ok{background:#2E7D32}
  .toast-err{background:#C62828}

  .draws-list{max-height:360px;overflow-y:auto}
  .draw-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #222;font-size:0.9em;gap:8px;flex-wrap:wrap}
  .draw-item .name{color:#FFD700;min-width:60px}
  .draw-item .code{font-family:monospace;color:#888;font-size:0.85em}
  .draw-item .time{color:#555;font-size:0.8em}

  .badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.8em;font-weight:600}
  .badge-0{background:linear-gradient(135deg,#FFD700,#FF6B35);color:#1a1a2e}
  .badge-1{background:linear-gradient(135deg,#FF4444,#FF6B6B);color:#fff}
  .badge-2{background:linear-gradient(135deg,#FF8E53,#FFA500);color:#fff}
  .badge-3{background:linear-gradient(135deg,#888,#bbb);color:#333}

  .empty{text-align:center;color:#555;padding:20px}
  #content{display:none}

  @media(max-width:600px){
    .prize-card{grid-template-columns:1fr}
    .field-label{text-align:left}
    .inp-name,.inp-desc,.inp-tier-name{width:100%}
  }
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ›ï¸ æŠ½å¥–ç®¡ç†åå°</h1>
  <p class="subtitle">ç¼–è¾‘å¥–å“ / è°ƒæ•´æ¦‚ç‡ / æŸ¥çœ‹è®°å½•</p>

  <div class="auth" id="authBox">
    <input type="password" id="authKey" placeholder="è¾“å…¥ç®¡ç†å¯†é’¥" onkeydown="if(event.key==='Enter')doAuth()">
    <button onclick="doAuth()">è¿›å…¥</button>
  </div>

  <div id="content">
    <!-- å¥–å“é…ç½® -->
    <div class="section">
      <h2>ğŸ å¥–å“é…ç½®</h2>
      <div class="prize-cards" id="prizeCards"></div>
      <div class="actions">
        <button class="btn btn-reset" onclick="loadConfig()">è¿˜åŸ</button>
        <button class="btn btn-save" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
      </div>
    </div>

    <!-- ä¸­å¥–è®°å½• -->
    <div class="section">
      <h2>ğŸ“‹ ä¸­å¥–è®°å½•</h2>
      <div class="draws-list" id="drawsList"></div>
    </div>

    <!-- å±é™©æ“ä½œ -->
    <div class="section">
      <h2>âš ï¸ å±é™©æ“ä½œ</h2>
      <div class="actions" style="justify-content:flex-start">
        <button class="btn btn-danger" onclick="doReset()">é‡ç½®æ‰€æœ‰æŠ½å¥–æ•°æ®</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let KEY='', config=[];
const TIER_OPTIONS = [
  {value:0, label:'è¶…çº§å¤§å¥–'},
  {value:1, label:'ç‰¹ç­‰å¥–'},
  {value:2, label:'ä¸€ç­‰å¥–'},
  {value:3, label:'äºŒç­‰å¥–'},
];

function doAuth(){
  KEY=document.getElementById('authKey').value.trim();
  if(!KEY) return;
  loadConfig().then(ok=>{
    if(ok){
      document.getElementById('authBox').style.display='none';
      document.getElementById('content').style.display='block';
      loadDraws();
    }
  });
}

async function loadConfig(){
  try{
    const r=await fetch('/api/admin/config?key='+KEY);
    if(!r.ok){toast('å¯†é’¥é”™è¯¯','err');return false}
    config=await r.json();
    renderCards();
    return true;
  }catch(e){toast('åŠ è½½å¤±è´¥','err');return false}
}

function renderCards(){
  const el=document.getElementById('prizeCards');
  const totalProb=config.filter(p=>!p.drawn).reduce((s,p)=>s+p.prob,0);
  const tierColors={0:'#FFD700',1:'#FF4444',2:'#FF8E53',3:'#888'};

  el.innerHTML=config.map((p,i)=>{
    const pct=p.drawn?'-':(totalProb>0?(p.prob/totalProb*100).toFixed(1)+'%':'0%');
    const barW=p.drawn?0:(totalProb>0?p.prob/totalProb*100:0);
    const tierOpts=TIER_OPTIONS.map(t=>`<option value="${t.value}" ${p.tier===t.value?'selected':''}>${t.label}</option>`).join('');

    return `<div class="prize-card ${p.drawn?'drawn':''}" data-idx="${i}">
      <div class="card-header">
        <div class="id-badge" style="background:${p.color||'#888'}">${p.id}</div>
        <span class="badge badge-${p.tier}">${esc(p.tierName)}</span>
        <strong>${esc(p.name)}</strong>
        <span class="status ${p.drawn?'status-drawn':'status-ok'}">${p.drawn?'å·²æŠ½å‡º':'å¾…æŠ½'}</span>
      </div>

      <span class="field-label">å¥–å“åç§°</span>
      <div class="field-row">
        <input class="inp inp-name" value="${esc(p.name)}" data-id="${p.id}" data-field="name" ${p.drawn?'disabled':''}>
      </div>

      <span class="field-label">å¥–å“æè¿°</span>
      <div class="field-row">
        <input class="inp inp-desc" value="${esc(p.desc||'')}" data-id="${p.id}" data-field="desc" ${p.drawn?'disabled':''}>
      </div>

      <span class="field-label">ç­‰çº§</span>
      <div class="field-row">
        <select class="inp inp-tier-name" data-id="${p.id}" data-field="tier" ${p.drawn?'disabled':''}>${tierOpts}</select>
        <input class="inp inp-color" type="color" value="${p.color||'#888888'}" data-id="${p.id}" data-field="color" ${p.drawn?'disabled':''}>
      </div>

      <span class="field-label">æ‰‡åŒºå¤§å°</span>
      <div class="field-row">
        <input class="inp inp-num" type="number" min="0.5" max="10" step="0.5" value="${p.visualWeight}" data-id="${p.id}" data-field="visualWeight" ${p.drawn?'disabled':''}>
      </div>

      <span class="field-label">æ¦‚ç‡æƒé‡</span>
      <div class="field-row">
        <input class="inp inp-num" type="number" min="0" max="100" step="1" value="${p.prob}" data-id="${p.id}" data-field="prob" ${p.drawn?'disabled':''}>
        <span style="font-size:0.85em;color:#aaa;min-width:45px">${pct}</span>
        <div class="prob-bar"><div class="prob-fill" style="width:${barW}%;background:${tierColors[p.tier]||'#888'}"></div></div>
      </div>
    </div>`;
  }).join('');

  // ç»‘å®šå®æ—¶æ›´æ–°
  el.querySelectorAll('.inp').forEach(inp=>{
    inp.addEventListener('change',()=>syncField(inp));
    inp.addEventListener('input',()=>{if(inp.type!=='number')syncField(inp)});
  });
}

function syncField(inp){
  const id=parseInt(inp.dataset.id);
  const field=inp.dataset.field;
  const p=config.find(x=>x.id===id);
  if(!p) return;

  if(field==='tier'){
    const tierVal=parseInt(inp.value);
    p.tier=tierVal;
    const match=TIER_OPTIONS.find(t=>t.value===tierVal);
    if(match) p.tierName=match.label;
  } else if(field==='prob'||field==='visualWeight'){
    p[field]=parseFloat(inp.value)||0;
  } else if(field==='color'){
    p[field]=inp.value;
  } else {
    p[field]=inp.value;
  }
  renderCards();
}

async function saveConfig(){
  const updates=config.map(p=>({
    id:p.id, name:p.name, desc:p.desc,
    tier:p.tier, tierName:p.tierName, color:p.color,
    prob:p.prob, visualWeight:p.visualWeight
  }));
  try{
    const r=await fetch('/api/admin/config?key='+KEY,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify(updates)
    });
    if(!r.ok){toast('ä¿å­˜å¤±è´¥','err');return}
    toast('âœ… é…ç½®å·²ä¿å­˜','ok');
    loadConfig();
  }catch(e){toast('ä¿å­˜å¤±è´¥','err')}
}

async function loadDraws(){
  try{
    const r=await fetch('/api/admin/draws?key='+KEY);
    const data=await r.json();
    const el=document.getElementById('drawsList');
    if(!data.draws||data.draws.length===0){
      el.innerHTML='<div class="empty">æš‚æ— ä¸­å¥–è®°å½•</div>';return;
    }
    el.innerHTML=data.draws.map(d=>`
      <div class="draw-item">
        <span class="name">${esc(d.nickname)}</span>
        <span class="badge badge-${d.tier||3}">${esc(d.tierName)}</span>
        <span>${esc(d.prizeName)}</span>
        <span class="code">${esc(d.code)}</span>
        <span class="time">${new Date(d.time).toLocaleString('zh-CN')}</span>
      </div>
    `).join('');
  }catch(e){}
}

async function doReset(){
  if(!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æŠ½å¥–æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤å›ï¼'))return;
  if(!confirm('å†æ¬¡ç¡®è®¤ï¼šæ‰€æœ‰ä¸­å¥–è®°å½•å’Œå…‘æ¢ç éƒ½å°†è¢«æ¸…é™¤ï¼'))return;
  try{
    await fetch('/api/admin/reset?key='+KEY,{method:'POST'});
    toast('å·²é‡ç½®','ok');
    loadConfig();loadDraws();
  }catch(e){toast('é‡ç½®å¤±è´¥','err')}
}

function toast(msg,type){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className='toast toast-'+type+' show';
  setTimeout(()=>el.classList.remove('show'),2000);
}

function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
</script>
</body>
</html>
